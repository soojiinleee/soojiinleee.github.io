{"componentChunkName":"component---src-templates-blog-post-js","path":"/sql/sql-syntax-error/","result":{"data":{"site":{"siteMetadata":{"title":"Blog"}},"markdownRemark":{"id":"d1430235-0932-599f-af1c-705706f6b424","excerpt":"airflow를 이용하여 매일 자정 공연 데이터를 수집하는 DAG 작성 중 발생한 오류 Contents 문제 상황 1\n문제 상황 2 문제 상황 1. 데이터 변환 후 SQL bulk insert을 위해 python…","html":"<p>airflow를 이용하여 매일 자정 공연 데이터를 수집하는 DAG 작성 중 발생한 오류</p>\n<h1>Contents</h1>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9-1.\">문제 상황 1</a><br>\n<a href=\"#%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9-2.\">문제 상황 2</a></p>\n<h1>문제 상황 1.</h1>\n<p>데이터 변환 후 SQL bulk insert을 위해 python의 <code class=\"language-text\">f-string</code>으로 처리하면서 문자열과 날짜 값을 모두 쌍따옴표로 처리</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">records <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nrecords<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>\n    <span class=\"token string-interpolation\"><span class=\"token string\">f'(\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>box_office_date<span class=\"token punctuation\">}</span></span><span class=\"token string\">\",</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>ranking<span class=\"token punctuation\">}</span></span><span class=\"token string\">,\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>performance_id<span class=\"token punctuation\">}</span></span><span class=\"token string\">\",\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>performance_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">\",\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>genre<span class=\"token punctuation\">}</span></span><span class=\"token string\">\",</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>performance_count<span class=\"token punctuation\">}</span></span><span class=\"token string\">,\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>area<span class=\"token punctuation\">}</span></span><span class=\"token string\">\")'</span></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">insert_sql <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"INSERT INTO t VALUES \"</span></span> <span class=\"token operator\">+</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">)</span></code></pre></div>\n<p>변환한 데이터를 redshift에 적재하니 아래 에러 발생</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token punctuation\">(</span>psycopg2<span class=\"token punctuation\">.</span><span class=\"token keyword\">errors</span><span class=\"token punctuation\">.</span>UndefinedColumn<span class=\"token punctuation\">)</span> <span class=\"token keyword\">column</span> <span class=\"token string\">\"2025-02-01 00:00:00\"</span> does <span class=\"token operator\">not</span> exist <span class=\"token operator\">in</span> box_office</code></pre></div>\n<p>bulk insert 문에 컬럼을 적어도 같은 에러 발생</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">insert_sql <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"INSERT INTO t (box_office_date,ranking,performance_id,performance_name,genre,performance_count,area) VALUES \"</span></span> <span class=\"token operator\">+</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- SQL 실행</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> box_office \n    <span class=\"token punctuation\">(</span>box_office_date<span class=\"token punctuation\">,</span>ranking<span class=\"token punctuation\">,</span>performance_id<span class=\"token punctuation\">,</span>performance_name<span class=\"token punctuation\">,</span>genre<span class=\"token punctuation\">,</span>performance_count<span class=\"token punctuation\">,</span>area<span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">VALUES</span> \n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"2025-02-01 00:00:00\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"PF258148\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"ATEEZ WORLD TOUR: TOWARDS THE LIGHT: WILL TO POWER [서울]\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"대중음악\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"서울\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"2025-02-01 00:00:00\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"PF254693\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"웃는 남자\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"뮤지컬\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">29</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"서울\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>오류 원인</h2>\n<ul>\n<li>SQL 쿼리에서 <code class=\"language-text\">VALUES</code> 안에 문자열이나 날짜 값에 쌍따옴표(<code class=\"language-text\">\"</code>) 대신 홑따옴표(<code class=\"language-text\">'</code>)를 사용</li>\n<li>PostgreSQL에서는\n<ul>\n<li><strong>쌍따옴표</strong>는 컬럼 또는 식별자를 나타내는 데 사용</li>\n<li><strong>홑따옴표</strong>로 문자열과 날짜 값을 감싸야 함</li>\n</ul>\n</li>\n</ul>\n<h2>오류 수정</h2>\n<p><code class=\"language-text\">f-string</code> 를 쌍따옴표로 하고 문자열은 홑따옴표로 처리</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">records <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nrecords<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>\n\t<span class=\"token string-interpolation\"><span class=\"token string\">f\"('</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>box_office_date<span class=\"token punctuation\">}</span></span><span class=\"token string\">',</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>ranking<span class=\"token punctuation\">}</span></span><span class=\"token string\">,'</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>performance_id<span class=\"token punctuation\">}</span></span><span class=\"token string\">','</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>performance_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">','</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>genre<span class=\"token punctuation\">}</span></span><span class=\"token string\">,</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>performance_count<span class=\"token punctuation\">}</span></span><span class=\"token string\">,'</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>area<span class=\"token punctuation\">}</span></span><span class=\"token string\">')\"</span></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h1>문제 상황 2.</h1>\n<p>문제 상황1은 해결 되었지만 airflow DAG 실행 시 실패하는 DAG 발생</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">psycopg2<span class=\"token punctuation\">.</span>errors<span class=\"token punctuation\">.</span>SyntaxError<span class=\"token punctuation\">:</span> syntax error at <span class=\"token keyword\">or</span> near <span class=\"token string\">\"t\"</span> <span class=\"token keyword\">in</span> context <span class=\"token string\">\"49,'PF257672','THE SKYSCRAPER: Can't\"</span><span class=\"token punctuation\">,</span> at line <span class=\"token number\">1</span>\nLINE <span class=\"token number\">1</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2025-01-21'</span><span class=\"token punctuation\">,</span><span class=\"token number\">49</span><span class=\"token punctuation\">,</span><span class=\"token string\">'PF257672'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'THE SKYSCRAPER: Can'</span>t be blue<span class=\"token punctuation\">,</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h2>오류 원인</h2>\n<p>홑따옴표가 포함된 문자열에 대한 처리가 없어서 생긴 오류</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">THE SKYSCRAPER: Can't be blue, PATZ, kimseungjoo</code></pre></div>\n<p>홑따옴표 두 개(<code class=\"language-text\">''</code>)를 사용하여 문자열 내에 홑따옴표를 포함</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> box_office \n<span class=\"token keyword\">VALUES</span> \n<span class=\"token punctuation\">(</span><span class=\"token string\">'2025-02-01 00:00:00'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'PF123456'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Can''t stop'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'뮤지컬'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'서울'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>오류 수정</h2>\n<p>데이터 변환 시 문자열에 홑따옴표가 있는지 확인하는 python 로직 추가</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">if</span> <span class=\"token string\">\"'\"</span> <span class=\"token keyword\">in</span> performance_name<span class=\"token punctuation\">:</span> <span class=\"token comment\"># (e.g) Can't be blue</span>\n    performance_name <span class=\"token operator\">=</span> performance_name<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"'\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"''\"</span><span class=\"token punctuation\">)</span></code></pre></div>","frontmatter":{"title":"✅ sql error - 따옴표","date":"February 04, 2025","description":"API를 이용해 데이터 수집 후 DB 적재 시 발생한 SQL의 따옴표 syntax 오류"}},"previous":{"fields":{"slug":"/book/practices-of-the-python-pro/"},"frontmatter":{"title":"📚 프로그래머를 위한 파이썬"}},"next":{"fields":{"slug":"/django/drf-pagination/"},"frontmatter":{"title":"📌 DRF 톺아보기 - Pagination"}}},"pageContext":{"id":"d1430235-0932-599f-af1c-705706f6b424","previousPostId":"60edd729-ef34-54be-9e9e-471169a06620","nextPostId":"c35c230f-7b77-5573-92d5-3f1446f10511"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}